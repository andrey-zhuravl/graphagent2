version: "3.9"

services:
  pgvector:
    image: ankane/pgvector:latest
    container_name: agent-pgvector1
    restart: unless-stopped
    ports:
      - "5422:5432"
    environment:
      POSTGRES_USER: agent
      POSTGRES_PASSWORD: agent123
      POSTGRES_DB: agentdb
    networks:
      - ai-network
    volumes:
      - D:\data\pgvector:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: agent-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    networks:
      - ai-network
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  n8n:
    image: docker.n8n.io/n8nio/n8n:latest
    container_name: n8n-ai-automation
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=your_secure_password
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=Europe/Moscow
      - N8N_LOG_LEVEL=debug  # Для разработки полезно
    ports:
      - "5678:5678"
    volumes:
      - ../n8n-data:/home/node/.n8n
      - ./local-files:/files  # Для доступа к локальным файлам
    networks:
      - ai-network
    restart: unless-stopped

  my-ai-agent:
    build: ./agent  # Путь к Dockerfile агента
    container_name: ai-agent-service
    ports:
      - "8000:8000"
    environment:
      - MCP_SERVER_URL=http://mcp-server:8000
      - QDRANT_URL=http://qdrant:6333
    networks:
      - ai-network
    restart: unless-stopped

networks:
  ai-network:
    driver: bridge

volumes:
  pgvector_data:
  n8n_data: